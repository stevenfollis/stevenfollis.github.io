<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on technology by Steven Follis">

    <title>Managing Azure Resource Manager (ARM) Template deployments with CSV files - Steven Follis</title>

    <link rel="canonical" href="http://localhost:4000/2016/11/21/managing-arm-templates-with-csv-parameters/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Steven Follis" />

</head>

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Managing Azure Resource Manager (ARM) Template deployments with CSV files | Steven Follis</title>
<meta property="og:title" content="Managing Azure Resource Manager (ARM) Template deployments with CSV files" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ARM Templates are great. They allow us to provision complex solutions in a repeatable and clearly understood manner. The parameters model enables flexible templates that can adapt to a variety of inputs, however the management of these parameter files can be cumbersome." />
<meta property="og:description" content="ARM Templates are great. They allow us to provision complex solutions in a repeatable and clearly understood manner. The parameters model enables flexible templates that can adapt to a variety of inputs, however the management of these parameter files can be cumbersome." />
<link rel="canonical" href="http://localhost:4000/2016/11/21/managing-arm-templates-with-csv-parameters/" />
<meta property="og:url" content="http://localhost:4000/2016/11/21/managing-arm-templates-with-csv-parameters/" />
<meta property="og:site_name" content="Steven Follis" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-21T08:56:16-05:00" />
<script type="application/ld+json">
{"name":null,"description":"ARM Templates are great. They allow us to provision complex solutions in a repeatable and clearly understood manner. The parameters model enables flexible templates that can adapt to a variety of inputs, however the management of these parameter files can be cumbersome.","author":null,"@type":"BlogPosting","url":"http://localhost:4000/2016/11/21/managing-arm-templates-with-csv-parameters/","publisher":null,"image":null,"headline":"Managing Azure Resource Manager (ARM) Template deployments with CSV files","dateModified":"2016-11-21T08:56:16-05:00","datePublished":"2016-11-21T08:56:16-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/11/21/managing-arm-templates-with-csv-parameters/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Steven Follis</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/chicago-stained-glass.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Managing Azure Resource Manager (ARM) Template deployments with CSV files</h1>
                    
                    <span class="meta">Posted by Steven Follis on November 21, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>ARM Templates are great.  They allow us to provision complex solutions in a repeatable and clearly understood manner.  The parameters model enables flexible templates that can adapt to a variety of inputs, however the management of these parameter files can be cumbersome.</p>

<p>During the planning phase of a project, Excel is often used to chart out the required virtual machines for a given solution. Let’s take the following values, and create a solution in Azure using Azure Resource Manager deployments.</p>

<p><img src="/content/images/2016/11/image-001-1.png" alt="screenshot" /></p>

<h2 id="create-a-console-application">Create a console application</h2>
<p>I generated a small console application written in NodeJS that will wire up several steps. I’m using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">ECMA6 Promises</a> Syntax to more easily control workflow, and avoid a world of callback mess.</p>

<blockquote>
  <p>ECMA6 Promises need Node <a href="http://www.infoworld.com/article/2981932/javascript/nodejs-4-0-0-arrives-with-ecmascript-6-backing.html">v4</a> or greater. Use <code class="highlighter-rouge">node -v</code> to ensure you are up to date, else visit <a href="http://nodejs.org">http://nodejs.org</a> and grab an updated version</p>
</blockquote>

<p>Scaffold out the console application with defining dependencies and setting up the Promise flow:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">msRestAzure</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ms-rest-azure'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">resourceManagement</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"azure-arm-resource"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Converter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"csvtojson"</span><span class="p">).</span><span class="nx">Converter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Converter</span><span class="p">({});</span>
<span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./config/config'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash'</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Starting deployment`</span><span class="p">);</span>

<span class="c1">// Login to Azure </span>
<span class="nx">login</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Execute in parallel all deployent preparation tasks</span>
        <span class="nb">Promise</span>
            <span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">createRG</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deploySharedTemplate</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">getParameters</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">parameters</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">([</span><span class="nx">client</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">]);</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deployTemplate</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>

                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Deployed ARM Template to Azure`</span><span class="p">);</span>

            <span class="p">});</span>

    <span class="p">});</span>
</code></pre></div></div>

<blockquote>
  <p>Find all source code for this console application on <a href="https://github.com/stevenfollis/Samples/tree/master/CSVProvisioner">GitHub</a></p>
</blockquote>

<h3 id="authenticate-with-a-service-principal">Authenticate with a Service Principal</h3>
<p>An Azure Service Principal is an application within Azure Active Directory that can be given specific permissions within an Azure Subscription.  In our scenario, we can give a Service Principal a <strong>Contributor</strong> role within our Azure Subscription, allowing the SP to create Resource Groups and Resources on our behalf.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// =========================================================</span>
<span class="c1">// Step 1: Login to Azure with a Service Principal</span>
<span class="c1">// https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal-cli/</span>
<span class="c1">// =========================================================</span>
<span class="kd">function</span> <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="nx">msRestAzure</span><span class="p">.</span><span class="nx">loginWithServicePrincipalSecret</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">APPLICATION_ID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">APPLICATION_SECRET</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">DOMAIN</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Authenticated with Azure via Service Principal`</span><span class="p">);</span>

            <span class="c1">// Create an ARM client</span>
            <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">resourceManagement</span><span class="p">.</span><span class="nx">ResourceManagementClient</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">AZURE_SUBSCRIPTION_ID</span><span class="p">);</span>

            <span class="c1">// Resolve client</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>

        <span class="p">});</span>

    <span class="p">});</span>

<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Service Principals can be created via the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal">Azure Portal</a>, <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authenticate-service-principal">PowerShell</a>, or the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authenticate-service-principal-cli">Azure XPlat CLI</a></p>
</blockquote>

<h3 id="create-a-resource-group">Create a Resource Group</h3>
<p>Our configuration file sets the name and region of a Resource Group that will hold all of our resources.  We also add a tag to the RG for further management capabilities in the future.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// =========================================================</span>
<span class="c1">// Step 2: Create an Azure Resource Group </span>
<span class="c1">// =========================================================</span>
<span class="kd">function</span> <span class="nx">createRG</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="c1">// Use the RM client to create a resource group</span>
        <span class="nx">client</span>
            <span class="p">.</span><span class="nx">resourceGroups</span>
            <span class="p">.</span><span class="nx">createOrUpdate</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Created Resource Group named </span><span class="p">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

                <span class="c1">// Resolve Promise</span>
                <span class="nx">resolve</span><span class="p">([</span><span class="nx">client</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">name</span><span class="p">]);</span>

            <span class="p">});</span>

    <span class="p">});</span>

<span class="p">}</span>
</code></pre></div></div>

<h3 id="deploy-shared-resources">Deploy Shared Resources.</h3>
<p>The CSV file lists 5 virtual machines, but there are separate resources that will be used across all of our virtual machines. Right now this consists of a Virtual Network that each VM will use.  These shared resources are defined in a dedicated ARM Template, and will generate an output value to be used in future steps.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// =========================================================</span>
<span class="c1">// Step 3: Deploy Shared Resources ARM Template</span>
<span class="c1">// =========================================================</span>
<span class="kd">function</span> <span class="nx">deploySharedTemplate</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">rgName</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">deploymentName</span> <span class="o">=</span> <span class="s2">`SharedResources-</span><span class="p">${</span><span class="nx">_</span><span class="p">.</span><span class="nx">random</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">999</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>

    <span class="c1">// Read template from disk</span>
    <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">sharedResourcesPath</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">deploymentParameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"parameters"</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">"template"</span><span class="p">:</span> <span class="nx">template</span><span class="p">,</span>
            <span class="s2">"mode"</span><span class="p">:</span> <span class="s2">"Incremental"</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="c1">// Deploy template</span>
        <span class="nx">client</span>
            <span class="p">.</span><span class="nx">deployments</span>
            <span class="p">.</span><span class="nx">createOrUpdate</span><span class="p">(</span><span class="nx">rgName</span><span class="p">,</span> <span class="nx">deploymentName</span><span class="p">,</span> <span class="nx">deploymentParameters</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Deployed Shared Resources ARM Template`</span><span class="p">);</span>

                <span class="c1">// Remove the Type attribute for the RG outputs</span>
                <span class="kd">var</span> <span class="nx">scrubbedOutputs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">mapValues</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">outputs</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">output</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">return</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="nx">output</span><span class="p">.</span><span class="nx">value</span> <span class="p">};</span>

                <span class="p">});</span>

                <span class="nx">resolve</span><span class="p">(</span><span class="nx">scrubbedOutputs</span><span class="p">);</span>

            <span class="p">});</span>

    <span class="p">});</span>

<span class="p">}</span>
</code></pre></div></div>

<h3 id="setup-parameters">Setup Parameters</h3>
<p>Each row of the CSV will become a set of parameters used for a deployment.  Since Azure works primarily out of JSON objects, we need to serialize the local CSV file into an array of JSON objects.  Then we will extend those parameters by adding the output value from the Shared Resources deployment so that each VM knows which virtual network to use.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// =========================================================</span>
<span class="c1">// Step 4: Parse CSV File containing ARM Template parameters and merge with Shared RG's outputs</span>
<span class="c1">// =========================================================</span>
<span class="kd">function</span> <span class="nx">getParameters</span><span class="p">(</span><span class="nx">sharedOutputs</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="nx">converter</span><span class="p">.</span><span class="nx">fromFile</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">filePath</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

            <span class="c1">// CSV values are returned as s tring (ex. {name: jane} )</span>
            <span class="c1">// ARM parameters have a format of parameter name, then a value object</span>
            <span class="c1">// ex. {name: jane} needs to be processed to {name: {value:jane}}</span>
            <span class="c1">// Loop through the original rows and process a new array</span>

            <span class="c1">// Create new array to hold processed parameters</span>
            <span class="kd">var</span> <span class="nx">processedParameters</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="c1">// Loop through the original values</span>
            <span class="nx">rows</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">row</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

                <span class="c1">// Adjust value from a string to an object</span>
                <span class="kd">var</span> <span class="nx">processed</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">mapValues</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">original</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">return</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="nx">original</span> <span class="p">};</span>

                <span class="p">});</span>

                <span class="c1">// Add parameters from Shared Resources deployment</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">assignIn</span><span class="p">(</span><span class="nx">processed</span><span class="p">,</span> <span class="nx">sharedOutputs</span><span class="p">);</span>

                <span class="c1">// Push new object into the array</span>
                <span class="nx">processedParameters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>

            <span class="p">});</span>

            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Parsed parameters CSV file`</span><span class="p">);</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">processedParameters</span><span class="p">);</span>

        <span class="p">});</span>

    <span class="p">});</span>

<span class="p">}</span>
</code></pre></div></div>

<h3 id="generate-vm-deployments">Generate VM Deployments</h3>
<p>We have an array of JSON objects corresponding to a desired VM.  We will loop through each of these objects, combining them with a Virtual Machine ARM Template to create a series of deployments to the Resource Group.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// =========================================================</span>
<span class="c1">// Step 5: Deploy specific ARM Template</span>
<span class="c1">// =========================================================</span>
<span class="kd">function</span> <span class="nx">deployTemplate</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="c1">// Set variables from the values array</span>
        <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">parameters</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">rgName</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="c1">// Read template from disk</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">filePath</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">));</span>

        <span class="c1">// Loop through the sets of parameters </span>
        <span class="c1">// creating a new deployment for each set in the parameters array</span>
        <span class="nx">parameters</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">parameter</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Define a unique deployment name</span>
            <span class="kd">var</span> <span class="nx">deploymentName</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">-</span><span class="p">${</span><span class="nx">_</span><span class="p">.</span><span class="nx">random</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">999</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>

            <span class="c1">// Define object for template deployment</span>
            <span class="kd">var</span> <span class="nx">deploymentParameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"parameters"</span><span class="p">:</span> <span class="nx">parameter</span><span class="p">,</span>
                    <span class="s2">"template"</span><span class="p">:</span> <span class="nx">template</span><span class="p">,</span>
                    <span class="s2">"mode"</span><span class="p">:</span> <span class="s2">"Incremental"</span>
                <span class="p">}</span>
            <span class="p">};</span>

            <span class="c1">// Deploy template</span>
            <span class="nx">client</span>
                <span class="p">.</span><span class="nx">deployments</span>
                <span class="p">.</span><span class="nx">createOrUpdate</span><span class="p">(</span><span class="nx">rgName</span><span class="p">,</span> <span class="nx">deploymentName</span><span class="p">,</span> <span class="nx">deploymentParameters</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Deployed ARM Template`</span><span class="p">);</span>

                <span class="p">});</span>

            <span class="c1">// Iterate the counter  </span>
            <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">===</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">resolve</span><span class="p">();</span>

        <span class="p">});</span>

    <span class="p">});</span>

<span class="p">}</span>
</code></pre></div></div>

<h2 id="run-the-console-application">Run the console application</h2>
<p>Navigate in the terminal to your working folder, and execute <code class="highlighter-rouge">node app.js</code> to start up the CSVProvisioner.</p>

<p><img src="/content/images/2016/11/image-002-2.png" alt="" /></p>

<blockquote>
  <p>Using <a href="http://cmder.net/">cmder</a> but works across any shell</p>
</blockquote>

<p>After a few minutes you should have a shiny new Resource Group full of resources that were defined in your CSV file (along with a shared VNet).</p>

<p><img src="/content/images/2016/11/image-003-1.png" alt="" /></p>

<h2 id="wind-down">Wind Down</h2>
<p>“Hello World” samples for Azure Resource Manager often use a simple template and a PowerShell command, but you can integrate ARM into your process in a variety of ways.  For those that rely on spreadsheets to plan and organize infrastructure deployments, this sample demonstrates how deploy a series of Virtual Machines defined in a CSV file into an Azure Resource Group.</p>

<blockquote>
  <p>Find all source code for this console application on <a href="https://github.com/stevenfollis/Samples/tree/master/CSVProvisioner">GitHub</a></p>
</blockquote>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/09/24/background-image-processing-with-azure-functions-and-nodejs/" data-toggle="tooltip" data-placement="top" title="Background image thumbnail processing with Azure Functions and NodeJS">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/12/12/continuous-integration-ci-for-arm-templates/" data-toggle="tooltip" data-placement="top" title="Continuous Integration (CI) for Azure Resource Manager (ARM) Templates with Visual Studio Team Services (VSTS)">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/steven_follis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/steven.follis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/stevenfollis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:steven.follis@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Steven Follis 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    


</body>

</html>
