<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on technology by Steven Follis">

    <title>Monitoring an Azure IoT Gateway with a Socket.io Module - Steven Follis</title>

    <link rel="canonical" href="http://localhost:4000/2017/05/08/monitoring-an-azure-iot-gateway-with-socket-io/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Steven Follis" />

</head>

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Monitoring an Azure IoT Gateway with a Socket.io Module | Steven Follis</title>
<meta property="og:title" content="Monitoring an Azure IoT Gateway with a Socket.io Module" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Internet of Things (IoT) solutions involve significant quantities of data. When that data is all nicely sent up into a cloud (such as Azure) it is straightforward to analyze and monitor. However, many hybrid IoT scenarios involve on-premises data that is never sent up to the cloud due to available bandwidth, cost, or data volume. We may be only sending aggregations or exceptions to the cloud, but operations teams on-prem may be wanting insight into the full data that is being generated." />
<meta property="og:description" content="Internet of Things (IoT) solutions involve significant quantities of data. When that data is all nicely sent up into a cloud (such as Azure) it is straightforward to analyze and monitor. However, many hybrid IoT scenarios involve on-premises data that is never sent up to the cloud due to available bandwidth, cost, or data volume. We may be only sending aggregations or exceptions to the cloud, but operations teams on-prem may be wanting insight into the full data that is being generated." />
<link rel="canonical" href="http://localhost:4000/2017/05/08/monitoring-an-azure-iot-gateway-with-socket-io/" />
<meta property="og:url" content="http://localhost:4000/2017/05/08/monitoring-an-azure-iot-gateway-with-socket-io/" />
<meta property="og:site_name" content="Steven Follis" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-05-08T10:59:51-04:00" />
<script type="application/ld+json">
{"name":null,"description":"Internet of Things (IoT) solutions involve significant quantities of data. When that data is all nicely sent up into a cloud (such as Azure) it is straightforward to analyze and monitor. However, many hybrid IoT scenarios involve on-premises data that is never sent up to the cloud due to available bandwidth, cost, or data volume. We may be only sending aggregations or exceptions to the cloud, but operations teams on-prem may be wanting insight into the full data that is being generated.","author":null,"@type":"BlogPosting","url":"http://localhost:4000/2017/05/08/monitoring-an-azure-iot-gateway-with-socket-io/","publisher":null,"image":null,"headline":"Monitoring an Azure IoT Gateway with a Socket.io Module","dateModified":"2017-05-08T10:59:51-04:00","datePublished":"2017-05-08T10:59:51-04:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/05/08/monitoring-an-azure-iot-gateway-with-socket-io/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Steven Follis</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/chicago-stained-glass.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Monitoring an Azure IoT Gateway with a Socket.io Module</h1>
                    
                    <span class="meta">Posted by Steven Follis on May 8, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p>Internet of Things (IoT) solutions involve significant quantities of data. When that data is all nicely sent up into a cloud (such as Azure) it is straightforward to analyze and monitor.  However, many hybrid IoT scenarios involve on-premises data that is never sent up to the cloud due to available bandwidth, cost, or data volume. We may be only sending aggregations or exceptions to the cloud, but operations teams on-prem may be wanting insight into the full data that is being generated.</p>

<p>One way to monitor on-prem data is to leverage the <a href="https://azure.microsoft.com/en-us/services/iot-hub/iot-gateway-sdk/">Azure IoT Gateway</a> that may be already in-place.  The IoT GW provides a structured approach to consuming data on-prem, processing the data, and uploading the data to a cloud service (such as an <a href="https://azure.microsoft.com/en-us/services/iot-hub/">Azure IoT Hub</a>) via a module pattern.  These modules can be devloped in Java, C#, Node.js, or C (or mix ‘n match).</p>

<p>Today we will extend the IoT GW with a module to visualize the full fire hose of on-prem data before it is processed and batched for upload. We will do this by creating a <a href="https://socket.io/">Socket.io</a> server that communicates real-time data over a <a href="https://en.wikipedia.org/wiki/WebSocket">WebSocket</a> to an HTML page:</p>

<p><img src="/content/images/2017/05/screenshot--1-.png" alt="CompletedDashboard" /></p>

<h1 id="run-the-sample">Run the Sample</h1>
<p>The IoT team has provided a <a href="https://github.com/Azure-Samples/azure-iot-gateway-samples">sample application</a> to demonstrate how the gateway works.  Follow the <a href="https://github.com/Azure-Samples/azure-iot-gateway-samples#how-to-run-javascript-modules-windows-10ubuntu-linux-14">setup instructions</a> for JavaScript and run the sample locally. Within a few minutes we get an IoT Gateway running, a module that generates sample device data for temperature and humidity, and a printer module that echoes the value into our terminal:</p>

<p><img src="/content/images/2017/05/sample-run.gif" alt="sample-running" /></p>

<p>Not bad! However, reading a cavalcade of sensor data is difficult in a terminal window. Instead, we can pipe that data feed into a browser for a more visual take on the same information. First we will create a new module, then update the gateway configuration to leverage the new module.</p>

<h1 id="create-the-socketio-module">Create the Socket.io module</h1>
<p>The sample includes a <a href="https://github.com/Azure-Samples/azure-iot-gateway-samples/blob/master/js/modules/printer.js">printer.js</a> module that receives messages from the pipeline and <a href="https://github.com/Azure-Samples/azure-iot-gateway-samples/blob/master/js/modules/printer.js#L17">logs</a> them to the console. We will improve on this but receiving the same messages, yet emitting them via Socket.io.</p>

<p>Create a new file in the <code class="highlighter-rouge">/modules</code> folder called <code class="highlighter-rouge">socketio.js</code> and paste the following code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'socket.io'</span><span class="p">)();</span>

<span class="kd">class</span> <span class="nx">SocketioModule</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Default port for the Socket.io server</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="nx">create</span><span class="p">(</span><span class="nx">broker</span><span class="p">,</span> <span class="nx">configuration</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">broker</span> <span class="o">=</span> <span class="nx">broker</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">configuration</span> <span class="o">=</span> <span class="nx">configuration</span><span class="p">;</span>

        <span class="c1">// Update port if provided as a configuration argument</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">configuration</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Attach socket.io to a port</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Started Socket.io server on port </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">receive</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Convert data into an object</span>
        <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">));</span>

        <span class="c1">// Emit a message via socket.io</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'message'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="nx">destroy</span><span class="p">()</span> <span class="p">{</span>

        <span class="c1">// Close socket on destroy</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`socketio.destroy`</span><span class="p">);</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SocketioModule</span><span class="p">();</span>
</code></pre></div></div>

<blockquote>
  <p>Notice the syntax is a bit different? Gateway modules support the fancy new(ish) <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">ES6 Class Syntax</a> so we used that format</p>
</blockquote>

<p>This new module is doing several things:</p>

<ul>
  <li>Implements the methods that each module needs to have - <code class="highlighter-rouge">create()</code> runs on startup, <code class="highlighter-rouge">receive()</code> processes a newly received message from the broker, and <code class="highlighter-rouge">destroy()</code> tidies up on shutdown. See the <a href="https://github.com/Azure/azure-iot-gateway-sdk/blob/master/core/devdoc/module.md">devdocs</a> for more details</li>
  <li>Instantiates a Socket.io server</li>
  <li>The constructor sets a default port of <code class="highlighter-rouge">8000</code>, or a custom port can be defined in the <code class="highlighter-rouge">configuration</code> argument of <code class="highlighter-rouge">create()</code>.</li>
  <li>When a message is received, a Socket.io event called <code class="highlighter-rouge">message</code> is emitted to the socket</li>
  <li>On shutdown, the Socket.io server is closed</li>
</ul>

<p>Be sure to use npm to install the Socket.io dependency in the <code class="highlighter-rouge">/js</code> folder of the sample:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install socket.io --save
</code></pre></div></div>

<h1 id="update-the-gateway-configuration">Update the gateway configuration</h1>
<p>Gateways take a configuration file, written in JSON, that handles 3 types of configurations:</p>

<ul>
  <li>Sets up <code class="highlighter-rouge">loaders</code> for each programming language. If you are using a Java module, you need to load Java, etc. Only load languages that your modules are using.</li>
  <li>Defines all <code class="highlighter-rouge">modules</code> to be used and any configuration arguments</li>
  <li>Establishes relationships between modules via <code class="highlighter-rouge">links</code> that define data from from Module A into Module B.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
      </span><span class="s2">"loaders"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
      </span><span class="s2">"modules: [],
      "</span><span class="err">links</span><span class="s2">": []
}
</span></code></pre></div></div>

<p>Opening the <code class="highlighter-rouge">gw.local.config.json</code> file from our sample, replace the <code class="highlighter-rouge">node_printer</code> module with the new module we created in the <code class="highlighter-rouge">modules</code> array:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node_socketio"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"loader"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"entrypoint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"main.path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"modules/socketio.js"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"args"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>We gave a <strong>name</strong> value of <code class="highlighter-rouge">node_socketio</code> to match the existing convention, but we could have named it <code class="highlighter-rouge">socketio</code>, <code class="highlighter-rouge">io</code>, or anything else our hearts desired</p>
</blockquote>

<p>The gateway now knows to load our module. To wire it into the pipeline, adjust the <code class="highlighter-rouge">links</code> section by replacing <code class="highlighter-rouge">node_printer</code> sink with our <code class="highlighter-rouge">node_socketio</code>.</p>

<p>The adjusted <code class="highlighter-rouge">gw.local.config.json</code> file now looks like:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"loaders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"modules"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node_sensor"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"loader"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"entrypoint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"main.path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"modules/sensor.js"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"args"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node_socketio"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"loader"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"entrypoint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"main.path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"modules/socketio.js"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"args"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node_sensor"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"sink"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node_socketio"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>Fun tip for links: use an <code class="highlighter-rouge">*</code> under <code class="highlighter-rouge">source</code> to grab all traffic coming into the gateway without a predecessor module (<a href="https://github.com/Azure/azure-iot-gateway-sdk/blob/master/samples/java_sample/src/java_sample_lin.json#L50-L53">example</a>)</p>
</blockquote>

<h1 id="restart-the-gateway">Restart the gateway</h1>
<p>With our new module primed, and the configuration options updated, let’s restart our gateway. From the <code class="highlighter-rouge">/js</code> folder, run the start command from a terminal window:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run local
</code></pre></div></div>

<p>The gateway should startup and inform us of the configured Socket.io port:</p>

<p><img src="/content/images/2017/05/restarted-gateway.PNG" alt="restarted gateway" /></p>

<p>At this point the <code class="highlighter-rouge">node_sensor</code> module is generating sample data, but we are not echoing everything to the console since the <code class="highlighter-rouge">node_printer</code> module was removed.</p>

<h1 id="create-a-user-interface">Create a user interface</h1>
<p>Our server is emitting events over a WebSocket, but we need a client to receive and visualize them. For this let’s use a simple HTML page. We can receive the events with <a href="https://github.com/socketio/socket.io-client">Socket.io’s JavaScript library</a>, and then visualize the data points with <a href="https://github.com/epochjs/epoch">Epoch</a>, a real-time charting library implemented in JavaScript. A smidge of <a href="http://jquery.com/">jQuery</a> will help with adding rows to a table, and <a href="https://getmdl.io/">Material Design Lite</a> will provide some nice lipstick.</p>

<p>Create a new file in the <code class="highlighter-rouge">/js</code> folder named <code class="highlighter-rouge">index.html</code> and paste in the following code:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"ie=edge"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;title&gt;</span>Sensor Data<span class="nt">&lt;/title&gt;</span>

    <span class="c">&lt;!-- CSS --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://fonts.googleapis.com/icon?family=Material+Icons"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/epoch/0.8.4/css/epoch.min.css"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;style&gt;</span>
        <span class="nc">.demo-layout-waterfall</span> <span class="nc">.mdl-layout__header-row</span> <span class="nc">.mdl-navigation__link</span><span class="nd">:last-of-type</span> <span class="p">{</span>
            <span class="nl">padding-right</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"demo-layout-waterfall mdl-layout mdl-js-layout"</span><span class="nt">&gt;</span>

        <span class="c">&lt;!-- Header --&gt;</span>
        <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"mdl-layout__header mdl-layout__header--waterfall"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- Top row, always visible --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-layout__header-row"</span><span class="nt">&gt;</span>
                <span class="c">&lt;!-- Title --&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-layout-title"</span><span class="nt">&gt;</span>Sensor Data<span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-layout-spacer"</span><span class="nt">&gt;&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-textfield mdl-js-textfield mdl-textfield--expandable
                  mdl-textfield--floating-label mdl-textfield--align-right"</span><span class="nt">&gt;</span>

                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-textfield__expandable-holder"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"mdl-textfield__input"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"sample"</span> <span class="na">id=</span><span class="s">"waterfall-exp"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/header&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-layout__drawer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-layout-title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/span&gt;</span>
            <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"mdl-navigation"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"mdl-navigation__link"</span> <span class="na">href=</span><span class="s">""</span><span class="nt">&gt;</span>Link<span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"mdl-navigation__link"</span> <span class="na">href=</span><span class="s">""</span><span class="nt">&gt;</span>Link<span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"mdl-navigation__link"</span> <span class="na">href=</span><span class="s">""</span><span class="nt">&gt;</span>Link<span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"mdl-navigation__link"</span> <span class="na">href=</span><span class="s">""</span><span class="nt">&gt;</span>Link<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;main</span> <span class="na">class=</span><span class="s">"mdl-layout__content"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"page-content"</span><span class="nt">&gt;</span>

                <span class="c">&lt;!-- Sensor Data Table --&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-grid"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--12-col"</span><span class="nt">&gt;</span>

                        <span class="nt">&lt;div&gt;</span>
                            <span class="c">&lt;!--d3 Colors: https://github.com/d3/d3-3.x-api-reference/blob/master/Ordinal-Scales.md--&gt;</span>
                            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-chip"</span> <span class="na">style=</span><span class="s">"float: right; background-color:#2ca02c; color:#FFF"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-chip__text"</span><span class="nt">&gt;</span>Device 3<span class="nt">&lt;/span&gt;</span>
                            <span class="nt">&lt;/span&gt;</span>

                            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-chip"</span> <span class="na">style=</span><span class="s">"float: right; background-color:#ff7f0e; color:#FFF"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-chip__text"</span><span class="nt">&gt;</span>Device 2<span class="nt">&lt;/span&gt;</span>
                            <span class="nt">&lt;/span&gt;</span>

                            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-chip"</span> <span class="na">style=</span><span class="s">"float: right; background-color:#1f77b4; color:#FFF"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mdl-chip__text"</span><span class="nt">&gt;</span>Device 1<span class="nt">&lt;/span&gt;</span>
                            <span class="nt">&lt;/span&gt;</span>

                            <span class="nt">&lt;h3&gt;</span>Humidity<span class="nt">&lt;/h3&gt;</span>
                            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"chart"</span> <span class="na">class=</span><span class="s">"epoch category10"</span> <span class="na">style=</span><span class="s">"width: 1000px; height: 200px; margin: 0 auto 20px"</span><span class="nt">&gt;&lt;/div&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>

                        <span class="nt">&lt;div&gt;</span>
                            <span class="nt">&lt;h3&gt;</span>Sensor Data<span class="nt">&lt;/h3&gt;</span>
                            <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"mdl-data-table mdl-js-data-table mdl-shadow--2dp"</span> <span class="na">style=</span><span class="s">"width: 100%"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;thead&gt;</span>
                                    <span class="nt">&lt;tr&gt;</span>
                                        <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"mdl-data-table__cell--non-numeric"</span><span class="nt">&gt;</span>Time<span class="nt">&lt;/th&gt;</span>
                                        <span class="nt">&lt;th&gt;</span>Device<span class="nt">&lt;/th&gt;</span>
                                        <span class="nt">&lt;th&gt;</span>Humidity<span class="nt">&lt;/th&gt;</span>
                                        <span class="nt">&lt;th&gt;</span>Temp<span class="nt">&lt;/th&gt;</span>
                                    <span class="nt">&lt;/tr&gt;</span>
                                <span class="nt">&lt;/thead&gt;</span>
                                <span class="nt">&lt;tbody&gt;&lt;/tbody&gt;</span>
                            <span class="nt">&lt;/table&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>

                    <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

            <span class="nt">&lt;/div&gt;</span>


        <span class="nt">&lt;/main&gt;</span>

    <span class="nt">&lt;/div&gt;</span>

    <span class="c">&lt;!-- JS --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://code.getmdl.io/1.3.0/material.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://cdnjs.cloudflare.com/ajax/libs/epoch/0.8.4/js/epoch.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>

        <span class="c1">// Change port from default 8000 if adjusted in server-side module args</span>
        <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">'http://localhost:8000'</span><span class="p">);</span>

        <span class="c1">// Process message when received from server</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'message'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Echo message to console</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

            <span class="c1">// Write data into new table row</span>
            <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">(</span><span class="s1">'table tbody'</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="s2">`&lt;tr&gt;&lt;td class="mdl-data-table__cell--non-numeric"&gt;</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">sensorId</span><span class="p">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">hmdt</span><span class="p">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">temp</span><span class="p">}</span><span class="s2">&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="c1">// Keep a tidy number of 25 table rows</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'table tbody tr'</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

            <span class="c1">// Update dataset</span>
            <span class="nx">chart</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                <span class="p">{</span> <span class="na">time</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="na">y</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">hmdt</span> <span class="p">},</span>
                <span class="p">{</span> <span class="na">time</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="na">y</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">hmdt</span> <span class="p">},</span>
                <span class="p">{</span> <span class="na">time</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="na">y</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">hmdt</span> <span class="p">}</span>
            <span class="p">]);</span>

        <span class="p">});</span>

        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

            <span class="c1">// Create chart with Epoch</span>
            <span class="nx">chart</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#chart'</span><span class="p">).</span><span class="nx">epoch</span><span class="p">({</span>
                <span class="na">type</span><span class="p">:</span> <span class="s1">'time.line'</span><span class="p">,</span>
                <span class="na">axes</span><span class="p">:</span> <span class="p">[</span><span class="s1">'left'</span><span class="p">,</span> <span class="s1">'bottom'</span><span class="p">,</span> <span class="s1">'right'</span><span class="p">],</span>
                <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="na">label</span><span class="p">:</span> <span class="s2">"Device 1"</span><span class="p">,</span> <span class="na">values</span><span class="p">:</span> <span class="p">[]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="na">label</span><span class="p">:</span> <span class="s2">"Device 2"</span><span class="p">,</span> <span class="na">values</span><span class="p">:</span> <span class="p">[]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="na">label</span><span class="p">:</span> <span class="s2">"Device 3"</span><span class="p">,</span> <span class="na">values</span><span class="p">:</span> <span class="p">[]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">});</span>

        <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>(And yes, I’m sorry for inserting the JS into a HTML file, but it makes this demo easier :) )</p>

<p>This HTML page loads all our dependencies, then uses JavaScript to listen on the Socket for an emitted event. It then updates the chart and the table to add the data to the page.</p>

<p>Ensure the gateway is still running, and open this local file directly in a browser:</p>

<p><img src="/content/images/2017/05/running-dashboard.gif" alt="running" /></p>

<h1 id="wrap-up">Wrap Up</h1>
<p>Today we took the Azure IoT Gateway and created a custom module that exposes messages from the gateway broker to a WebSocket via Socket.io. We then attached a dashboard UI to visualize the data in real-time.</p>

<p>This scenario targets on-premises teams that want a real-time look at their gateway traffic, without standing up significant amounts of infrastructure, by tapping into the robust module structure of the IoT Gateway. While this was done totally in JavaScript, we could have used a variety of languages to build our custom module.</p>

<p>This module has been published on <a href="https://www.npmjs.com/package/iot-gateway-socketio">npm</a> for ease of use and is available on <a href="https://github.com/stevenfollis/iot-gateway-socketio">GitHub</a> (including a complete <a href="https://github.com/stevenfollis/iot-gateway-socketio/tree/master/sample">sample</a>).</p>

<p>Thanks!</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/12/12/continuous-integration-ci-for-arm-templates/" data-toggle="tooltip" data-placement="top" title="Continuous Integration (CI) for Azure Resource Manager (ARM) Templates with Visual Studio Team Services (VSTS)">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/06/02/nothotdog/" data-toggle="tooltip" data-placement="top" title=""Not Hotdog" from the Silicon Valley TV show with Cognitive Services + Bot Framework">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/steven_follis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/steven.follis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/stevenfollis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="mailto:steven.follis@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Steven Follis 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    


</body>

</html>
